# Refer for explanation to following link:
# https://lefthook.dev/configuration/

pre-commit:
  parallel: true
  commands:
    changelog:
      run: |
        SRC_CHANGED=$(git diff --cached --name-only | grep '^packages/vite-plugin-sitemap/src/')
        CHANGELOG_CHANGED=$(git diff --cached --name-only | grep '^CHANGELOG.md')
        if [ -n "$SRC_CHANGED" ] && [ -z "$CHANGELOG_CHANGED" ]; then
          echo "‚ùå ERROR: Files in src/ were modified but CHANGELOG.md was not updated."
          echo "‚û°Ô∏è  Please add your changes under the [Unreleased] section."
          exit 1
        else
          echo "‚úÖ Changelog check passed"
        fi
    version-check:
      run: |
        TAG=$(git describe --tags --exact-match 2>/dev/null)
        if [ -n "$TAG" ]; then
          echo "üè∑Ô∏è Tag detected: $TAG"
          echo "üîç Checking for version bump in package.json..."

          if ! git diff HEAD~1..HEAD --name-only | grep -q "^package.json$"; then
            echo "‚ùå ERROR: package.json version was not updated for tag $TAG"
            exit 1
          fi

          PKG_VERSION=$(node -p "require('./package.json').version")

          CLEAN_TAG=${TAG#v}

          if [ "$PKG_VERSION" != "$CLEAN_TAG" ]; then
            echo "‚ùå ERROR: Version mismatch!"
            echo "Tag: $CLEAN_TAG"
            echo "package.json: $PKG_VERSION"
            exit 1
          fi

          echo "‚úÖ Version matches tag: $TAG"
        else
          echo "‚ÑπÔ∏è No tag detected ‚Äì normal push"
        fi
    lint:
      glob: "*.{js,ts,mjs}"
      run: bun run lint
    typecheck:
      run: bun run typecheck
    format:
      glob: "*.{js,ts,mjs,json,md}"
      run: bun prettier --check {staged_files}

pre-push:
  commands:
    test:
      run: bun run test
